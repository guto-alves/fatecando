<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	th:replace="~{fragments/layout :: base(${discipline.code}, ~{::body}, _, _, ~{::style})}">
<head>
<meta charset="utf-8">
<style type="text/css">
#editor-container {
	height: 350px;
}

.list-card-item {
	cursor: pointer;
}

.list-card-item:hover {
	transform: scale(1.010);
}
</style>
</head>
<body>
	<div class="row">
		<div class="p-3 bg-dark text-white">
			<div class="card-body">
				<h3 class="card-title text-center fw-bolder" th:text="${discipline.code} + ' - ' +${discipline.name}"></h3>

				<div class="col-10 offset-1">
					<div class="mb-3">
						<h5 class="d-inline">Ementa:</h5>
						<span th:text="${discipline.description}"></span>
					</div>

					<h5 class="d-inline">Objetivo:</h5>
					<span th:text="${discipline.objective}"></span>

					<div class="d-flex justify-content-end mt-3">
						<div class="btn-group rounded-start" role="group" aria-label="Like toggle button">
							<input type="checkbox" class="btn-check" id="likeButton" autocomplete="off"
								th:checked="${discipline.user.liked}">
							<label id="likeStatus" class="btn btn-outline-primary p-2" for="likeButton">
								Curtir <i class="fa fa-thumbs-up"></i>
							</label>
						</div>
						<span id="totalLikes"
							class="fw-bolder text-primary border border-1 border-start-0 border-primary p-2 rounded-end"
							th:classappend="${discipline.user.liked} ? 'bg-white'" th:text="${discipline.likes}"></span>
					</div>
				</div>
			</div>

			<div class="progress text-center" style="height: 25px;" th:with="progress=${discipline.user.progress}">
				<div class="progress-bar progress-bar-striped progress-bar-animated fw-bolder" role="progressbar"
					aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width: 55%"
					th:style="'width: ' + ${progress} + '%'" th:classappend="${progress} == 100 ? 'bg-green' : 'bg-danger'"
					th:text="${progress} > 0 ? ${progress} + '% Estudado'">55% estudado</div>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="alert alert-success alert-dismissible fade show my-5" role="alert"
			th:if="${!#strings.isEmpty(message)}">
			<span class="text-center" th:text="${message}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>

		<!-- Topic Form -->
		<div class="accordion my-5" id="newTopicContainer">
			<div class="accordion-item">
				<h6 class="accordion-header" id="headingTwo">
					<button class="accordion-button collapsed bg-danger text-white fw-bold" type="button"
						data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false"
						aria-controls="collapseTwo" style="height: 50px">
						<h6>Deseja compartilhar seu conhecimento ? Contribua agora!</h6>
					</button>
				</h6>
				<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
					data-bs-parent="#newTopicContainer">
					<div class="accordion-body">

						<div class="card border border-1 border-secondary shadow">
							<div class="card-body">
								<h4 class="card-title text-center"
									th:utext="'Sentiu falta de algum tópico/assunto interessante em ' + ${#strings.arraySplit(discipline.name, ' ')[0]}  + '? <br> Manda pra gente!'">
								</h4>

								<div class="alert alert-danger alert-dismissible fade show m-3" role="alert" th:if="${error}">
									<span class="text-center">Houve um erro ao enviar o conteúdo. Verifique os dados e tente
										novamente.</span>
									<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
								</div>

								<form id="topic-form" action="#" method="post" th:action="@{/disciplines/{id}(id=${discipline.id})}"
									th:object="${topic}">
									<div class="mb-3 mt-2">
										<label class="form-label fw-bold" for="name">Nome</label>

										<input type="text" id="name" class="form-control" placeholder="Nome do tópico" th:field="*{name}"
											maxlength="255" required>

										<div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Nome
											inválido</div>
									</div>

									<div class="mb-3">
										<label class="form-label fw-bold" for="description">Descrição</label>

										<textarea id="description" class="form-control" placeholder="Uma breve descrição ..."
											th:field="*{description}" rows="3" maxlength="1000" required></textarea>

										<span class="text-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}">Descrição
											inválida</span>
									</div>

									<div class="mb-3">
										<label class="form-label fw-bold" for="bodyHtml">Conteúdo</label>

										<div id="topic-body-editor" th:utext="${topic.bodyHtml}"></div>

										<input type="hidden" th:field="*{bodyHtml}" aria-describedby="bodyHtmlFeedback">

										<div id="bodyHtmlFeedback" class="invalid-feedback" th:if="${#fields.hasErrors('bodyHtml')}"
											th:errors="*{bodyHtml}">Conteúdo inválido</div>
									</div>

									<div class="mb-3">
										<label class="fw-bold">Você acha que esse novo conteúdo deveria ser adicionado ao conjunto
											de tópicos "obrigatórios" para a conclusão da Disciplina?</label>

										<div class="form-check">
											<input class="form-check-input" type="radio" name="required" id="flexRadioDefault1" value="true"
												th:field="*{required}">
											<label class="form-check-label" for="flexRadioDefault1"> Sim, é este um dos principais
												tópicos da disciplina.</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="radio" name="required" id="flexRadioDefault2" value="false"
												th:field="*{required}">
											<label class="form-check-label" for="flexRadioDefault2"> Não, é apenas um conteúdo extra.</label>
										</div>
									</div>

									<div class="d-grid gap-2 col-6 mx-auto">
										<button type="submit" class="btn btn-warning btn-lg form-control mt-5 fw-bold">
											Enviar <i class="fa fa-cloud-upload"></i>
										</button>
									</div>
								</form>

							</div>
						</div>

					</div>
				</div>
			</div>
		</div>

		<div class="card shadow">
			<div class="card-header">
				<ul class="nav nav-tabs fw-bolder">
					<li class="nav-item">
						<a class="nav-link" href="#"
							th:classappend="|${page == 'topics'? 'active': ''} ${page == 'topics'? 'text-danger' : 'text-dark'}|"
							th:href="@{/disciplines/{id}(id=${discipline.id}, page='topics')}">Tópicos</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#"
							th:classappend="|${page == 'tests'? 'active': ''} ${page == 'tests'? 'text-danger' : 'text-dark'}|"
							th:href="@{/disciplines/{id}(id=${discipline.id}, page='tests')}">Teste</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#"
							th:classappend="|${page == 'forum'? 'active': ''} ${page == 'forum'? 'text-danger' : 'text-dark'}|"
							th:href="@{/disciplines/{id}(id=${discipline.id}, page='forum')}">Fórum</a>
					</li>
				</ul>
			</div>
			<div class="card-body ">
				<!-- Topics -->
				<div id="topics" class="list-group" th:if="${#strings.equalsIgnoreCase(page, 'topics')}">
					<div class="list-group-item list-card-item mb-3 border-1 shadow" th:each="topic : ${topics}"
						th:onclick="'showTopic(\'' + ${topic.id} + '\');'" th:data-id="${topic.id}"
						th:classappend="${topic.user.finished} ? 'border-success' : 'border-secondary'">
						<div class="d-flex w-100 justify-content-between">
							<div class="d-flex align-items-center">
								<h5 class="mb-1 fw-bolder" th:text="${topic.name}">Topic Name</h5>
								<i class="bi bi-grip-horizontal ms-2" style="font-size: 1.5rem;" sec:authorize="hasRole('ROLE_ADMIN')"></i>
							</div>

							<i class="fa fa-check-circle fa-2x green" aria-hidden="true"
								th:classappend="${!topic.user.finished}? 'd-none'"></i>
						</div>

						<p class="mb-1 truncate" th:text="${topic.description}">Some placeholder content in a paragraph.</p>

						<div class="d-flex justify-content-end align-items-center">
							<i class="fa fa-thumbs-o-up fa-lg text-primary me-1"></i> <small class="fw-bold" th:text=${topic.likes}>10</small>
						</div>
					</div>
				</div>

				<!-- Test -->
				<div th:if="${#strings.equalsIgnoreCase(page, 'tests')}">

					<div class="card border border-1 border-dark shadow">
						<h4 class="card-header text-center">Novo Teste</h4>
						<div class="card-body">
							<form action="#" method="post" th:action="@{/disciplines/{id}/test(id=${discipline.id})}"
								th:object="${test}">
								<div class="alert alert-danger alert-dismissible fade show" role="alert"
									th:if="${#fields.hasErrors('name') || #fields.hasErrors('topics')}">
									<span class="text-center">Erro ao criar teste. Verifique os campos e tente novamente!</span>
									<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
								</div>

								<div class="mb-3">
									<label class="form-label">Dê um nome para o Teste</label>
									<input type="text" class="form-control"
										placeholder="Por exemplo: Treinamento para a P1, Teste para P1, Teste BD, ..." required
										th:field="*{name}" th:classappend="${#fields.hasErrors('name')}? 'is-invalid'"
										aria-describedby="nameFeedback" onclick="this.select();">
									<div id="nameFeedback" class="invalid-feedback" th:if="${#fields.hasErrors('name')}"
										th:errors="*{name}">Mensagem de erro</div>
								</div>

								<div class="mb-4">
									<label class="form-label">Tópicos</label>
									<select class="form-select select2" multiple="multiple" th:field="*{topics}"
										th:classappend="${#fields.hasErrors('topics')}? 'is-invalid'" aria-describedby="topicsFeedback">
										<option th:each="topic : ${topics}" th:value="${topic.id}" th:text="${topic.name}"></option>
									</select>

									<div id="topicsFeedback" class="invalid-feedback" th:if="${#fields.hasErrors('topics')}"
										th:errors="*{topics}">Mensagem de erro</div>
								</div>

								<div class="d-grid gap-2 col-6 mx-auto">
									<button type="submit" class="btn btn-dark fw-bold">Iniciar</button>
								</div>

								<hr class="mt-5">
								<h5>Como funciona os Teste Rápido</h5>
								<p>
									O <b>Teste Rápido</b> é mais uma das formas que o Fatecando possui para práticar o conteúdo estudo.
									Desta maneira, você só precisar dar um nome para o teste e selecionar os tópicos que deseja treinar e
									iniciar. Ao iniciar, você será direcionado para uma página onde terá que responder as questões para
									finalizá-lo.
								</p>
							</form>
						</div>
					</div>
				</div>

				<!-- Forum -->
				<div th:if="${#strings.equalsIgnoreCase(page, 'forum')}">
					<div class="card bg-white mb-3">
						<div class="card-body">
							<label>Precisa de Ajuda?</label>

							<!-- Button trigger modal -->
							<button type="button" class="btn btn-outline-dark fw-bold" data-bs-toggle="modal"
								data-bs-target="#forumTopicModal">Criar um novo Tópico</button>

							<!-- Modal -->
							<div class="modal fade" id="forumTopicModal" tabindex="-1" aria-labelledby="exampleModalLabel"
								aria-hidden="true">
								<div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="exampleModalLabel"
												th:text="${discipline.code} + ' - Novo Tópico para o Fórum'">Novo Tópico Fórum</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<form id="forum-topic-form" action="#" method="post"
												th:action="@{/disciplines/{id}/forum-topics(id=${discipline.id})}" th:object="${forumTopic}">
												<div>
													<div class="mb-3">
														<label for="title">Título</label>
														<small class="d-flex text-muted">Seja específico e imagine que você está fazendo esta
															pergunta para outra pessoa</small>
														<input id="title" type="text" class="form-control" required th:field="*{title}">
													</div>

													<div class="mb-3">
														<label for="forum-topic-body-editor">Descrição</label>
														<small class="d-flex text-muted">Inclua todas as informações que alguém precisaria para
															responder sua pergunta</small>
														<div id="forum-topic-body-editor"></div>
														<input type="hidden" id="bodyHtml" th:field="*{bodyHtml}" required></input>
													</div>

													<div class="mb-3">
														<label for="topics">Tópicos de Tag</label>
														<small class="d-flex text-muted">Adicione o(s) tópico(s) que tem haver com sua pergunta</small>
														<select class="form-select select2-tags" multiple th:field="*{tags}"
															th:classappend="${#fields.hasErrors('tags')}? 'is-invalid'" aria-describedby="topicsFeedback"
															style="width: 100%;">
															<option th:each="topic : ${topics}" th:value="${topic.id}" th:text="${topic.name}"></option>
														</select>

														<div id="topicsFeedback" class="invalid-feedback" th:if="${#fields.hasErrors('tags')}"
															th:errors="*{tags}">Mensagem de erro</div>
													</div>
												</div>
											</form>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
											<button type="submit" class="btn btn-danger" onclick="$('#forum-topic-form').submit();">Criar</button>
										</div>
									</div>

								</div>
							</div>
						</div>
					</div>

					<div class="list-group" th:unless="${#lists.isEmpty(forumTopics)}">
						<a href="#" class="list-group-item list-group-item-action list-card-item mb-3 border-1 shadow" th:each="topic : ${forumTopics}"
							th:href="@{/disciplines/{id}/forum-topics/{topicId}(id=${discipline.id}, topicId=${topic.id})}">

							<div class="d-flex w-100 justify-content-between">
								<h5 class="mb-1" th:text="${topic.title}">Topic Title</h5>
								<time class="text-muted timeago" th:datetime="${#dates.formatISO(topic.creationDate)}">3 days
									ago</time>
							</div>
							<div class="mb-1 truncate" th:utext="${topic.bodyHtml}">Some placeholder content in a paragraph.</div>

							<div class="d-flex justify-content-between align-items-center">
								<div class="tags align-self-center">
									<span class="badge rounded-pill bg-dark me-2" th:each="tag : ${topic.tags}" th:text="${tag.name}"></span>
								</div>

								<small th:text="'Criado por ' + ${topic.user.fullName}">Criado por Gustavo Alves.</small>
							</div>
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript" th:src="@{/js/timeago/timeago.js}"></script>
	<script type="text/javascript" th:src="@{/js/timeago/jquery.timeago.pt-br.js}"></script>
	<script type="text/javascript" th:src="@{/js/quill-utils.js}"></script>

	<script type="text/javascript" th:inline="javascript">
		$("time.timeago").timeago();
		$('.select2').select2({
			closeOnSelect: false
		});
		$('.select2-tags').select2();

		$('#likeButton').click(function() {
			$.post(location.href.split('?')[0] + '/like')
				.done(function() {
					$('#totalLikes').toggleClass('bg-white');

					let totalLikes = parseInt($('#totalLikes').text());
					let liked = $('#totalLikes').hasClass('bg-white');
					
					$('#totalLikes').text(liked ? totalLikes + 1 : totalLikes - 1);
				});
		});

		var topicBodyEditor = new Quill('#topic-body-editor', EditorOptions.TOPIC);
		$('#topic-form').submit(function(event) {
			if (topicBodyEditor.root.innerText.trim() !== '') {
				$('#topic-form #bodyHtml').val(topicBodyEditor.root.innerHTML);
			}
		});
		
		var forumTopicBodyEditor = new Quill('#forum-topic-body-editor', EditorOptions.FORUM_TOPIC);
		$('#forum-topic-form').submit(function(event) {
			if (forumTopicBodyEditor.root.innerText.trim() !== '') {
				$('#forum-topic-form #bodyHtml').val(forumTopicBodyEditor.root.innerHTML);
			}
		});
		
		$('#contribute').click(function(event) {
			if ($('button[class*="accordion-button"]').hasClass('collapsed')) {
				event.preventDefault();
				$('button[class*="accordion-button"]').click();
				setTimeout(() => location.href = location.href.split('#')[0] + "#newTopicContainer", 200);
			}
		});
		
		if (/*[[${error}]]*/false) {
			$('button[class*="accordion-button"]').click();
			setTimeout(() => $('#contribute').click(), 300);
		}
		
		function showTopic(topicId) {
			location.href = '/topic/' + topicId;
		}
	</script>

	<script type="text/javascript" sec:authorize="hasRole('ROLE_ADMIN')">
		var el = document.getElementById('topics');
		
		Sortable.create(el, {
			animation: 150,
			onEnd: function (event) {
				let draggedTopicId = $(event.item).data('id');
				let relatedTopicId;
				
				if (event.newDraggableIndex > event.oldDraggableIndex) {
					relatedTopicId = $('#topics').children().eq(event.newDraggableIndex - 1).data('id');
				} else {
					relatedTopicId = $('#topics').children().eq(event.newDraggableIndex + 1).data('id');			
				}
				
				$.post(window.location.origin + `/admin/topics/drag/${draggedTopicId}/${relatedTopicId}`);
			}
		});
	</script>
</body>
</html>